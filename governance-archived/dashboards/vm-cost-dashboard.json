{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "dashboardName": {
      "type": "string",
      "defaultValue": "Enterprise-VM-Cost-Dashboard",
      "metadata": {
        "description": "Name of the dashboard"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for the dashboard"
      }
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.Portal/dashboards",
      "apiVersion": "2020-09-01-preview",
      "name": "[parameters('dashboardName')]",
      "location": "[parameters('location')]",
      "tags": {
        "hidden-title": "VM Cost Dashboard"
      },
      "properties": {
        "lenses": [
          {
            "order": 0,
            "parts": [
              {
                "position": {
                  "x": 0,
                  "y": 0,
                  "rowSpan": 4,
                  "colSpan": 6
                },
                "metadata": {
                  "inputs": [],
                  "type": "Extension/HubsExtension/PartType/MarkdownPart",
                  "settings": {
                    "content": {
                      "settings": {
                        "content": "# VM Cost Dashboard\n\n## Cost Management Overview\n\nMonitor and optimize Azure VM spending across environments.\n\n### Key Metrics\n- **Monthly Spend**: Total VM compute and storage costs\n- **Cost by Environment**: dev, uat, prod breakdown\n- **Top Spenders**: Most expensive VMs\n- **Cost Trends**: Month-over-month comparison\n\n### Cost Optimization\n- Right-size oversized VMs\n- Deallocate dev/test VMs after hours\n- Use Azure Reserved Instances\n- Enable auto-shutdown policies\n\n### Quick Links\n- [Cost Management](https://portal.azure.com/#blade/Microsoft_Azure_CostManagement/Menu/overview)\n- [Azure Advisor](https://portal.azure.com/#blade/Microsoft_Azure_Expert/AdvisorMenuBlade/Cost)\n- [Reservations](https://portal.azure.com/#blade/Microsoft_Azure_Reservations/ReservationsBrowseBlade)",
                        "title": "Overview",
                        "subtitle": "VM Cost Management"
                      }
                    }
                  }
                }
              },
              {
                "position": {
                  "x": 6,
                  "y": 0,
                  "rowSpan": 4,
                  "colSpan": 6
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "scope",
                      "value": "/subscriptions/{subscription-id}"
                    },
                    {
                      "name": "query",
                      "value": {
                        "type": "ActualCost",
                        "timeframe": "MonthToDate",
                        "dataset": {
                          "granularity": "Daily",
                          "aggregation": {
                            "totalCost": {
                              "name": "Cost",
                              "function": "Sum"
                            }
                          },
                          "filter": {
                            "dimensions": {
                              "name": "ResourceType",
                              "operator": "In",
                              "values": [
                                "Microsoft.Compute/virtualMachines",
                                "Microsoft.Compute/disks"
                              ]
                            }
                          }
                        }
                      }
                    }
                  ],
                  "type": "Extension/Microsoft_Azure_CostManagement/PartType/CostAnalysisPart",
                  "settings": {}
                }
              },
              {
                "position": {
                  "x": 0,
                  "y": 4,
                  "rowSpan": 4,
                  "colSpan": 6
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/microsoft.insights/components/{app-insights}"
                    },
                    {
                      "name": "Query",
                      "value": "Resources\n| where type == 'microsoft.compute/virtualmachines'\n| extend Environment = tostring(tags.Environment)\n| extend CostCenter = tostring(tags.CostCenter)\n| extend VMSize = tostring(properties.hardwareProfile.vmSize)\n| summarize VMCount=count() by Environment\n| extend EstimatedMonthlyCost = case(\n    Environment == 'prod', VMCount * 150,\n    Environment == 'uat', VMCount * 100,\n    Environment == 'dev', VMCount * 50,\n    VMCount * 75\n  )\n| project Environment, VMCount, EstimatedMonthlyCost\n| order by EstimatedMonthlyCost desc"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "Resources\n| where type == 'microsoft.compute/virtualmachines'\n| extend Environment = tostring(tags.Environment)\n| summarize VMCount=count() by Environment\n| extend EstimatedMonthlyCost = case(\n    Environment == 'prod', VMCount * 150,\n    Environment == 'uat', VMCount * 100,\n    Environment == 'dev', VMCount * 50,\n    VMCount * 75\n  )\n| project Environment, VMCount, EstimatedMonthlyCost\n| order by EstimatedMonthlyCost desc",
                      "ControlType": "FrameControlChart",
                      "SpecificChart": "StackedColumn",
                      "Dimensions": {
                        "xAxis": {
                          "name": "Environment",
                          "type": "string"
                        },
                        "yAxis": [
                          {
                            "name": "EstimatedMonthlyCost",
                            "type": "real"
                          }
                        ],
                        "splitBy": [],
                        "aggregation": "Sum"
                      }
                    }
                  }
                }
              },
              {
                "position": {
                  "x": 6,
                  "y": 4,
                  "rowSpan": 4,
                  "colSpan": 6
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/microsoft.insights/components/{app-insights}"
                    },
                    {
                      "name": "Query",
                      "value": "Resources\n| where type == 'microsoft.compute/virtualmachines'\n| extend CostCenter = tostring(tags.CostCenter)\n| summarize VMCount=count() by CostCenter\n| extend EstimatedMonthlyCost = VMCount * 100\n| project CostCenter, VMCount, EstimatedMonthlyCost\n| order by EstimatedMonthlyCost desc\n| take 10"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "Resources\n| where type == 'microsoft.compute/virtualmachines'\n| extend CostCenter = tostring(tags.CostCenter)\n| summarize VMCount=count() by CostCenter\n| extend EstimatedMonthlyCost = VMCount * 100\n| project CostCenter, VMCount, EstimatedMonthlyCost\n| order by EstimatedMonthlyCost desc\n| take 10",
                      "ControlType": "FrameControlChart",
                      "SpecificChart": "Pie"
                    }
                  }
                }
              },
              {
                "position": {
                  "x": 0,
                  "y": 8,
                  "rowSpan": 4,
                  "colSpan": 6
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/microsoft.insights/components/{app-insights}"
                    },
                    {
                      "name": "Query",
                      "value": "Resources\n| where type == 'microsoft.compute/virtualmachines'\n| extend VMSize = tostring(properties.hardwareProfile.vmSize)\n| summarize VMCount=count() by VMSize\n| extend CostMultiplier = case(\n    VMSize startswith 'Standard_B', 1.0,\n    VMSize startswith 'Standard_D', 2.0,\n    VMSize startswith 'Standard_E', 3.0,\n    VMSize startswith 'Standard_F', 2.5,\n    1.5\n  )\n| extend EstimatedMonthlyCost = VMCount * 100 * CostMultiplier\n| project VMSize, VMCount, EstimatedMonthlyCost\n| order by EstimatedMonthlyCost desc\n| take 10"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "Resources\n| where type == 'microsoft.compute/virtualmachines'\n| extend VMSize = tostring(properties.hardwareProfile.vmSize)\n| summarize VMCount=count() by VMSize\n| extend CostMultiplier = case(\n    VMSize startswith 'Standard_B', 1.0,\n    VMSize startswith 'Standard_D', 2.0,\n    VMSize startswith 'Standard_E', 3.0,\n    VMSize startswith 'Standard_F', 2.5,\n    1.5\n  )\n| extend EstimatedMonthlyCost = VMCount * 100 * CostMultiplier\n| project VMSize, VMCount, EstimatedMonthlyCost\n| order by EstimatedMonthlyCost desc\n| take 10",
                      "ControlType": "AnalyticsGrid"
                    }
                  }
                }
              },
              {
                "position": {
                  "x": 6,
                  "y": 8,
                  "rowSpan": 4,
                  "colSpan": 6
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/microsoft.insights/components/{app-insights}"
                    },
                    {
                      "name": "Query",
                      "value": "Resources\n| where type == 'microsoft.compute/disks'\n| extend DiskSize = toint(properties.diskSizeGB)\n| extend DiskSKU = tostring(sku.name)\n| summarize TotalDiskSizeGB=sum(DiskSize), DiskCount=count() by DiskSKU\n| extend CostPerGB = case(\n    DiskSKU == 'Premium_LRS', 0.135,\n    DiskSKU == 'StandardSSD_LRS', 0.075,\n    DiskSKU == 'Standard_LRS', 0.045,\n    0.10\n  )\n| extend EstimatedMonthlyCost = TotalDiskSizeGB * CostPerGB\n| project DiskSKU, DiskCount, TotalDiskSizeGB, EstimatedMonthlyCost\n| order by EstimatedMonthlyCost desc"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "Resources\n| where type == 'microsoft.compute/disks'\n| extend DiskSize = toint(properties.diskSizeGB)\n| extend DiskSKU = tostring(sku.name)\n| summarize TotalDiskSizeGB=sum(DiskSize), DiskCount=count() by DiskSKU\n| extend CostPerGB = case(\n    DiskSKU == 'Premium_LRS', 0.135,\n    DiskSKU == 'StandardSSD_LRS', 0.075,\n    DiskSKU == 'Standard_LRS', 0.045,\n    0.10\n  )\n| extend EstimatedMonthlyCost = TotalDiskSizeGB * CostPerGB\n| project DiskSKU, DiskCount, TotalDiskSizeGB, EstimatedMonthlyCost\n| order by EstimatedMonthlyCost desc",
                      "ControlType": "AnalyticsGrid"
                    }
                  }
                }
              },
              {
                "position": {
                  "x": 0,
                  "y": 12,
                  "rowSpan": 4,
                  "colSpan": 12
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/microsoft.insights/components/{app-insights}"
                    },
                    {
                      "name": "Query",
                      "value": "Resources\n| where type == 'microsoft.compute/virtualmachines'\n| extend VMSize = tostring(properties.hardwareProfile.vmSize)\n| extend Environment = tostring(tags.Environment)\n| extend CostCenter = tostring(tags.CostCenter)\n| extend Owner = tostring(tags.Owner)\n| extend CostMultiplier = case(\n    VMSize startswith 'Standard_B', 1.0,\n    VMSize startswith 'Standard_D', 2.0,\n    VMSize startswith 'Standard_E', 3.0,\n    VMSize startswith 'Standard_F', 2.5,\n    1.5\n  )\n| extend EstimatedMonthlyCost = 100 * CostMultiplier\n| project VMName=name, VMSize, Environment, CostCenter, Owner, EstimatedMonthlyCost, location\n| order by EstimatedMonthlyCost desc\n| take 20"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "Resources\n| where type == 'microsoft.compute/virtualmachines'\n| extend VMSize = tostring(properties.hardwareProfile.vmSize)\n| extend Environment = tostring(tags.Environment)\n| extend CostCenter = tostring(tags.CostCenter)\n| extend Owner = tostring(tags.Owner)\n| extend CostMultiplier = case(\n    VMSize startswith 'Standard_B', 1.0,\n    VMSize startswith 'Standard_D', 2.0,\n    VMSize startswith 'Standard_E', 3.0,\n    VMSize startswith 'Standard_F', 2.5,\n    1.5\n  )\n| extend EstimatedMonthlyCost = 100 * CostMultiplier\n| project VMName=name, VMSize, Environment, CostCenter, Owner, EstimatedMonthlyCost, location\n| order by EstimatedMonthlyCost desc\n| take 20",
                      "ControlType": "AnalyticsGrid"
                    }
                  }
                }
              }
            ]
          }
        ],
        "metadata": {
          "model": {
            "timeRange": {
              "value": {
                "relative": {
                  "duration": 24,
                  "timeUnit": 1
                }
              },
              "type": "MsPortalFx.Composition.Configuration.ValueTypes.TimeRange"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "dashboardId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Portal/dashboards', parameters('dashboardName'))]"
    }
  }
}
