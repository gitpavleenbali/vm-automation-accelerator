# Setup Guide: Managed Identity Authentication for Azure DevOps Pipeline

## üìã Overview

This guide will help you configure **Managed Identity with Workload Identity Federation** for your Azure DevOps pipeline. This is the modern, secure approach recommended by Microsoft that eliminates the need for Service Principal secrets.

### Why Managed Identity?

- ‚úÖ **No secrets to manage** - No client secrets or certificates
- ‚úÖ **Works with Azure CLI** - Supports user-based authentication mode in Terraform
- ‚úÖ **Modern & Secure** - Microsoft's recommended approach
- ‚úÖ **Automatic token management** - Azure handles token refresh

### Your Environment Details

| Detail | Value |
|--------|-------|
| **Subscription ID** | `37ffd444-46e0-41dd-9e4b-f12857262095` |
| **Subscription Name** | `ME-MngEnvMCAP852047-pavleenbali-1` |
| **Tenant ID** | `f1755a38-88fd-47a4-a2e9-5c2019dc2535` |
| **Azure DevOps Org** | `azdopavleenbali` |
| **Project** | `A-Z of Azure` |
| **Current Service Connection** | `azure-vm-automation-connection` (to be replaced) |

---

## üöÄ Step-by-Step Implementation

### Step 1: Create Managed Identity in Azure Portal

1. **Navigate to Azure Portal**
   - Go to https://portal.azure.com
   - Make sure you're in the correct tenant: **f1755a38-88fd-47a4-a2e9-5c2019dc2535** (Contoso)

2. **Create Managed Identity**
   - In the search box, type: **Managed Identities**
   - Click **+ Create**

3. **Fill in details**:
   ```
   Subscription:   ME-MngEnvMCAP852047-pavleenbali-1
   Resource Group: rg-vmaut-mgmt-eus-main-rg (or create new: rg-devops-identities)
   Region:         East US (or your preferred region)
   Name:           mi-vmautomation-pipeline-identity
   ```

4. **Create and capture details**
   - Click **Review + Create** ‚Üí **Create**
   - Wait for deployment to complete
   - Click **Go to resource**
   
5. **Copy these values** (you'll need them later):
   - **Client ID** (from Overview page)
   - **Tenant ID** (from Overview page - should be f1755a38-88fd-47a4-a2e9-5c2019dc2535)
   - **Subscription** (should be 37ffd444-46e0-41dd-9e4b-f12857262095)

---

### Step 2: Grant Subscription Permissions

1. **Navigate to your subscription**
   - In Azure Portal search box, type: **Subscriptions**
   - Click on: **ME-MngEnvMCAP852047-pavleenbali-1**

2. **Add role assignment**
   - In left menu, click **Access control (IAM)**
   - Click **+ Add** ‚Üí **Add role assignment**

3. **Select role**
   - Search for: **Contributor**
   - Select it and click **Next**

4. **Assign to managed identity**
   - Select **Managed identity**
   - Click **+ Select members**
   - In the dropdown, select **User-assigned managed identity**
   - Search for: **mi-vmautomation-pipeline-identity**
   - Click **Select**
   - Click **Next**

5. **Complete assignment**
   - Review the details
   - Click **Review + assign**

‚úÖ **Verification**: Go back to the managed identity ‚Üí Access control (IAM) ‚Üí View my access. You should see "Contributor" role on the subscription.

---

### Step 3: Create Service Connection in Azure DevOps (Draft)

1. **Navigate to Azure DevOps**
   - Go to: https://dev.azure.com/azdopavleenbali/A-Z%20of%20Azure
   - Click **Project settings** (bottom left gear icon)

2. **Open Service Connections**
   - In left menu, click **Service connections** (under Pipelines)
   - Click **New service connection**

3. **Select connection type**
   - Select **Azure Resource Manager**
   - Click **Next**

4. **Select authentication method**
   - Select **App registration or Managed identity (manual)**
   - Select credential: **Workload identity federation**
   - Click **Next**

5. **Fill in Step 1: Service connection details**:
   ```
   Service connection name: azure-vm-automation-managed-identity
   Description: Managed Identity for VM Automation Pipeline (Workload Identity Federation)
   ```
   - Click **Next**

6. **Fill in Step 2: App registration details**:

   **Environment**: Select **AzureCloud**
   
   **Scope Level**: Select **Subscription**
   
   **Subscription details**:
   ```
   Subscription Id:   37ffd444-46e0-41dd-9e4b-f12857262095
   Subscription Name: ME-MngEnvMCAP852047-pavleenbali-1
   ```
   
   **Authentication section**:
   ```
   Application (client) ID: [Paste the Client ID you copied from managed identity]
   Directory (tenant) ID:   f1755a38-88fd-47a4-a2e9-5c2019dc2535
   ```

7. **IMPORTANT: Copy these generated values**:
   - **Issuer** (automatically generated by Azure DevOps)
   - **Subject identifier** (automatically generated by Azure DevOps)
   
   ‚ö†Ô∏è **Keep this browser tab open!** You'll need these values in the next step.

8. **Security settings**:
   - ‚ùå Do NOT check "Grant access permission to all pipelines" (better security)
   - You'll authorize the specific pipeline later

9. **Save as draft**:
   - Click **Keep as draft** (NOT "Verify and save" yet!)
   - The connection will be saved but not active until you complete the federated credential setup

---

### Step 4: Configure Federated Credentials in Azure Portal

1. **Return to Azure Portal** (keep Azure DevOps tab open)
   - Navigate back to your managed identity: **mi-vmautomation-pipeline-identity**

2. **Open Federated credentials**
   - In left menu, go to **Settings** ‚Üí **Federated credentials**
   - Click **+ Add credential**

3. **Select scenario**
   - In the **Federated credential scenario** dropdown, select **Other issuer**

4. **Enter credential details**:
   ```
   Issuer:              [Paste the Issuer URL from Azure DevOps - Step 3.7]
   Subject identifier:  [Paste the Subject identifier from Azure DevOps - Step 3.7]
   Type:                Explicit subject identifier
   Name:                azdo-vm-automation-pipeline-federation
   Description:         Federated credential for Azure DevOps VM Automation Pipeline
   ```

5. **Save**:
   - Click **Add**
   - Wait for the credential to be created

‚úÖ **Verification**: You should see the new federated credential in the list with status "Active".

---

### Step 5: Finalize Service Connection in Azure DevOps

1. **Return to Azure DevOps** (the tab you kept open)
   - You should still be on the draft service connection page

2. **Complete setup**:
   - Click **Finish setup**

3. **Verify connection**:
   - The system will now validate the connection
   - Click **Verify and save**
   - You should see: ‚úÖ **"Verification succeeded"**

4. **If verification fails**:
   - Double-check the Client ID and Tenant ID
   - Verify the federated credential in Azure Portal is active
   - Ensure the managed identity has Contributor role on the subscription
   - Wait 1-2 minutes for Azure AD propagation, then try again

‚úÖ **Verification**: The service connection status should show as "Ready" with a green checkmark.

---

### Step 6: Update Pipeline Configuration

Now you need to update your pipeline to use the new service connection.

1. **Open your pipeline YAML file**:
   - File: `.azuredevops/pipelines/vm-automation-ci-cd.yml`

2. **Update the service connection variable** (Line 26):
   
   **Change FROM**:
   ```yaml
   azureSubscription: 'azure-vm-automation-connection'
   ```
   
   **Change TO**:
   ```yaml
   azureSubscription: 'azure-vm-automation-managed-identity'
   ```

3. **Revert back to AzureCLI@2 task** (Lines 131-148, 176-193, 268-280):
   
   Managed Identity works perfectly with AzureCLI@2 task. You need to revert the AzurePowerShell@5 changes from commit a364628.
   
   **Change FROM**:
   ```yaml
   - task: AzurePowerShell@5
     displayName: 'Execute A-to-Z Deployment Script'
     inputs:
       azureSubscription: $(azureSubscription)
       scriptType: 'filePath'
       scriptPath: 'Deploy-VMAutomationAccelerator.ps1'
       scriptArguments: |
         -Environment $(targetEnvironment) 
         -ValidateOnly:$(${{ eq(parameters.deploymentAction, 'validate') }}) 
         -DestroyAfterValidation:$(${{ eq(parameters.deploymentAction, 'destroy') }})
       azurePowerShellVersion: 'LatestVersion'
       workingDirectory: '$(System.DefaultWorkingDirectory)'
       pwsh: true
   ```
   
   **Change TO**:
   ```yaml
   - task: AzureCLI@2
     displayName: 'Execute A-to-Z Deployment Script'
     inputs:
       azureSubscription: $(azureSubscription)
       scriptType: 'pwsh'
       scriptLocation: 'scriptPath'
       scriptPath: 'Deploy-VMAutomationAccelerator.ps1'
       arguments: |
         -Environment $(targetEnvironment) 
         -ValidateOnly:$(${{ eq(parameters.deploymentAction, 'validate') }}) 
         -DestroyAfterValidation:$(${{ eq(parameters.deploymentAction, 'destroy') }})
       workingDirectory: '$(System.DefaultWorkingDirectory)'
   ```

4. **Apply this change to all 3 stages**: Dev (line ~138), UAT (line ~185), Prod (line ~273)

---

### Step 7: Update PowerShell Script (Optional Cleanup)

The PowerShell script has Service Principal authentication handling that's no longer needed for managed identity. However, keeping it won't hurt since it will simply skip that logic when ARM_CLIENT_ID is not set.

**Optional changes to `Deploy-VMAutomationAccelerator.ps1`**:

The authentication diagnostic section (lines 241-285) will automatically detect that it's running with managed identity (no ARM_CLIENT_ID) and skip the SP authentication logic. You don't need to change anything unless you want to clean up the code.

---

### Step 8: Authorize Pipeline to Use Service Connection

1. **In Azure DevOps**, go to the new service connection:
   - Project settings ‚Üí Service connections
   - Click on: **azure-vm-automation-managed-identity**

2. **Authorize pipeline**:
   - Click on the **three dots** (‚ãÆ) ‚Üí **Security**
   - Under **Pipeline permissions**, click **+** (Add)
   - Search for your pipeline: **vm-automation-ci-cd**
   - Select it and click **Add**

‚úÖ **Verification**: The pipeline should now appear in the "Pipeline permissions" list.

---

### Step 9: Commit and Push Changes

```powershell
# Stage changes
git add .azuredevops/pipelines/vm-automation-ci-cd.yml

# Commit with detailed message
git commit -m "feat: Migrate to Managed Identity with Workload Identity Federation

BREAKING CHANGE: Replaced Service Principal authentication with Managed Identity

Why this change:
- Service Principal (SP) authentication was causing 'Azure CLI only supports User' error
- Managed Identity provides modern, secure, passwordless authentication
- Works seamlessly with AzureCLI@2 task for Terraform deployments

Changes:
- Updated azureSubscription variable to use 'azure-vm-automation-managed-identity'
- Reverted AzurePowerShell@5 back to AzureCLI@2 for all stages (Dev/UAT/Prod)
- Managed identity: mi-vmautomation-pipeline-identity (Client ID: <paste-client-id>)
- Uses Workload Identity Federation (OIDC) - no secrets required

Azure Resources Created:
- Managed Identity: mi-vmautomation-pipeline-identity in East US
- Federated Credential: azdo-vm-automation-pipeline-federation
- Role Assignment: Contributor on subscription 37ffd444-46e0-41dd-9e4b-f12857262095

Testing: Pipeline should now authenticate via managed identity and Terraform 
should recognize it as user-mode authentication (not Service Principal)."

# Push to Azure DevOps
git push azuredevops feature/vm-automation-accelerator-unified-solution-v1.0
```

---

### Step 10: Test the Pipeline

1. **Run the pipeline**:
   - Go to: Pipelines ‚Üí vm-automation-ci-cd
   - Click **Run pipeline**
   - Select deployment action: **Validate only**
   - Click **Run**

2. **Monitor execution**:
   - Watch the "Execute A-to-Z Deployment Script" step
   - Check for the authentication diagnostic output
   - Verify Terraform init completes WITHOUT the "Azure CLI is only supported as a User" error

3. **Expected behavior**:
   - ‚úÖ AzureCLI@2 task authenticates using managed identity
   - ‚úÖ Terraform detects Azure CLI authentication in user mode (not Service Principal)
   - ‚úÖ Terraform init/plan/apply complete successfully
   - ‚úÖ No authentication errors

---

## üîç Troubleshooting

### Issue: "Verification failed" when saving service connection

**Causes**:
- Federated credential not yet active in Azure (wait 1-2 minutes)
- Wrong Client ID or Tenant ID
- Managed identity doesn't have permission on subscription

**Solution**:
1. Wait 2 minutes for Azure AD propagation
2. Verify Client ID matches managed identity
3. Check role assignment in Azure Portal

---

### Issue: Pipeline fails with "Resource not found" error

**Cause**: Pipeline not authorized to use the service connection

**Solution**:
1. Go to service connection ‚Üí Security ‚Üí Pipeline permissions
2. Add your pipeline explicitly

---

### Issue: Terraform still shows "Azure CLI is only supported as a User" error

**Causes**:
- Still using old service connection (Service Principal)
- Pipeline YAML not updated to use new connection name

**Solution**:
1. Check pipeline YAML line 26: should be `'azure-vm-automation-managed-identity'`
2. Verify the pipeline run is using the new connection (check logs)
3. Ensure you reverted back to AzureCLI@2 task

---

## üìö Additional Resources

- [Official Microsoft Docs: Workload Identity Federation](https://learn.microsoft.com/en-us/azure/devops/pipelines/release/configure-workload-identity?view=azure-devops)
- [Managed Identities Overview](https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/overview)
- [Azure DevOps Service Connections](https://learn.microsoft.com/en-us/azure/devops/pipelines/library/service-endpoints)

---

## ‚úÖ Success Criteria

Your setup is complete when:

- [ ] Managed identity created and has Contributor role on subscription
- [ ] Federated credential active in Azure Portal
- [ ] Service connection verified and saved in Azure DevOps
- [ ] Pipeline YAML updated with new service connection name
- [ ] Pipeline authorized to use the service connection
- [ ] Changes committed and pushed to Azure DevOps
- [ ] **Pipeline runs successfully without authentication errors**
- [ ] Terraform init/plan/apply complete successfully

---

## üéâ What's Next?

Once the pipeline works successfully:

1. **Delete the old service connection**: 
   - Project settings ‚Üí Service connections ‚Üí azure-vm-automation-connection ‚Üí Delete

2. **Document the change**: Update your team's documentation to reflect the new authentication method

3. **Celebrate**: You've successfully migrated to modern, secure, passwordless authentication! üöÄ

---

**Created**: October 20, 2025
**Author**: GitHub Copilot
**For**: VM Automation Accelerator Pipeline Migration
